<div id="onboarding-shell" class="onboarding-container">

  <!-- Step 1: Location & Prayer Calculation -->
  <div class="onboarding-step" id="step-1" data-step="1">
    <div class="onboarding-content">
      <!-- Illustration -->
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="120" height="120" style="margin: 0 auto;">
          <circle cx="100" cy="100" r="80" fill="#4a9d6f" opacity="0.8"/>
          <path d="M 100 20 Q 150 60 150 100 Q 150 140 100 160 Q 50 140 50 100 Q 50 60 100 20" fill="#f4d856"/>
          <circle cx="75" cy="85" r="12" fill="#4a9d6f"/>
          <g transform="translate(130, 50)">
            <circle cx="0" cy="0" r="16" fill="#000" opacity="0.8"/>
            <circle cx="0" cy="0" r="14" fill="#fff"/>
            <circle cx="0" cy="0" r="6" fill="#000"/>
          </g>
        </svg>
      </div>

      <h1 class="onb-title" style="text-align: center; margin-top: 24px;">Your Location</h1>

      <div class="onb-location-display">
        <div class="onb-location-header">
          <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Current Location</h3>
        </div>
        <p id="location-display-address" style="margin: 0 0 8px 0; font-size: 14px; color: var(--text-primary);">Detecting location...</p>
        <p id="location-display-timezone" style="margin: 0; font-size: 13px; color: var(--text-secondary);">Time Zone: --</p>
      </div>

      <button id="skip-location-btn" style="width: 100%; margin-top: 12px; padding: 10px; background: transparent; border: 1px solid var(--divider); border-radius: 8px; font-size: 13px; cursor: pointer; color: var(--text-secondary); display: none;">Skip Location (Use Manual Calculation)</button>

      <div style="margin-top: 28px;">
        <h2 style="font-size: 18px; margin: 0 0 12px 0;">Prayer Time Calculation</h2>
        <p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 16px 0;">Select your preferred calculation method or let the app find it for accurate prayer times in your area.</p>

        <div class="onb-dropdown-group">
          <button class="onb-dropdown-btn" id="calc-method-btn">
            <span>Calculation Method</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span id="calc-method-value" style="font-weight: 600;">Karachi</span>
              <i data-lucide="chevron-down" style="width: 18px; height: 18px;"></i>
            </div>
          </button>
          <select id="calculation-method" style="display: none;">
            <option value="Karachi">Karachi (Shafi)</option>
            <option value="ISNA">ISNA (North America)</option>
            <option value="MWL">Muslim World League</option>
            <option value="Makkah">Umm Al-Qura (Makkah)</option>
            <option value="Egypt">Egyptian General Authority</option>
            <option value="Dubai">Dubai (Gulf)</option>
          </select>
        </div>

        <div class="onb-dropdown-group" style="margin-top: 12px;">
          <button class="onb-dropdown-btn" id="asr-method-btn">
            <span>Asr Calculation</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span id="asr-method-value" style="font-weight: 600;">Hanafi</span>
              <i data-lucide="chevron-down" style="width: 18px; height: 18px;"></i>
            </div>
          </button>
          <select id="asr-method" style="display: none;">
            <option value="Shafi">Shafi</option>
            <option value="Hanafi" selected>Hanafi</option>
          </select>
        </div>

        <p style="margin-top: 12px; font-size: 13px; color: #4caf50; text-align: center;">The calculation method is set automatically; you can change it if needed.</p>
      </div>

      <button style="width: 100%; margin-top: 20px; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; color: var(--text-primary);">See Country & Method List</button>

      <button class="onb-btn-next" id="step-1-next" style="margin-top: 32px;">Continue</button>
    </div>
  </div>

  <!-- Step 2: Language Selection -->
  <div class="onboarding-step" id="step-2" data-step="2" style="display:none;">
    <div class="onboarding-content">
      <!-- Illustration: Bangladesh Flag -->
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="100" height="100" style="margin: 0 auto;">
          <!-- Flag pole -->
          <rect x="70" y="80" width="8" height="80" fill="#333"/>
          <!-- Flag -->
          <path d="M 78 90 Q 140 85 140 120 Q 140 155 78 150 Z" fill="#1aa260"/>
          <!-- Red circle (Bangladesh flag) -->
          <circle cx="105" cy="120" r="20" fill="#e21e1e"/>
        </svg>
      </div>

      <!-- Title & Description -->
      <h1 class="onb-title" style="color: var(--primary); text-align: center;">Choose preferred language</h1>
      <p class="onb-description" style="text-align: center; margin-top: 12px; font-size: 14px;">Deen app comes with both English and Bangla language. Choose your preferred language to continue.</p>

      <!-- Language Toggle -->
      <div style="display: flex; justify-content: center; margin: 32px 0;">
        <div class="onb-language-toggle">
          <label class="onb-toggle-option">
            <input type="radio" name="language" value="en" class="onb-toggle-radio" checked>
            <span class="onb-toggle-label">English</span>
          </label>
          <label class="onb-toggle-option">
            <input type="radio" name="language" value="bn" class="onb-toggle-radio">
            <span class="onb-toggle-label">Bangla</span>
          </label>
        </div>
      </div>

      <!-- Next Button -->
      <button class="onb-btn-next" id="step-2-next" style="margin-top: 40px;">Continue</button>
    </div>
  </div>

  <!-- Step 3: Hijri Date Adjustment -->
  <div class="onboarding-step" id="step-3" data-step="3" style="display:none;">
    <div class="onboarding-content">
      <!-- Illustration: Space/Planets -->
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="120" height="120" style="margin: 0 auto;">
          <!-- Dark blue circle background -->
          <circle cx="100" cy="100" r="90" fill="#3d5a80" opacity="0.7"/>
          <!-- Stars -->
          <circle cx="60" cy="40" r="2" fill="#fff" opacity="0.6"/>
          <circle cx="140" cy="50" r="1.5" fill="#fff" opacity="0.5"/>
          <circle cx="160" cy="140" r="1" fill="#fff" opacity="0.4"/>
          <!-- Sun (yellow) -->
          <circle cx="100" cy="100" r="32" fill="#ffc107"/>
          <!-- Earth -->
          <circle cx="50" cy="60" r="16" fill="#4caf50"/>
          <circle cx="55" cy="55" r="4" fill="#ffeb3b"/>
          <!-- Saturn with rings -->
          <circle cx="140" cy="120" r="18" fill="#cd853f"/>
          <ellipse cx="140" cy="120" rx="28" ry="8" fill="none" stroke="#a67035" stroke-width="2"/>
          <!-- Rocket -->
          <g transform="translate(75, 45)">
            <polygon points="0,-15 -8,5 -3,5 3,5 8,5" fill="#ff5722"/>
            <rect x="-5" y="5" width="10" height="12" fill="#e0e0e0"/>
          </g>
        </svg>
      </div>

      <!-- Title & Description -->
      <h1 class="onb-title" style="text-align: center;">Adjust Hijri Date</h1>
      <p class="onb-description" style="text-align: center; margin-top: 16px; font-size: 14px;">Some countries (Bangladesh, India, Pakistan and other South Asian countries) are 1 day behind from Saudi Arabia in terms of moon sighting. You may adjust Hijri date by your location or keep it as same as Saudi Arabia.</p>

      <!-- Slider Container -->
      <div style="margin: 32px 0;">
        <div class="onb-slider-fancy">
          <div class="onb-slider-track">
            <input type="range" id="hijri-offset-slider" min="-2" max="2" value="0" step="1" class="onb-slider-input">
          </div>
          <div class="onb-slider-labels-row">
            <span>-2</span>
            <span>-1</span>
            <span style="font-weight: 600; color: var(--primary);">0</span>
            <span>+1</span>
            <span>+2</span>
          </div>
        </div>
      </div>

      <!-- Label -->
      <p style="text-align: center; font-size: 14px; color: var(--text-secondary); margin-top: 24px;">Same day as Saudi Arabia</p>

      <!-- Next Button -->
      <button class="onb-btn-next" id="step-3-next" style="margin-top: 48px;">Continue</button>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="onb-progress">
    <div class="onb-progress-dots">
      <div class="onb-dot active" data-step="1"></div>
      <div class="onb-dot" data-step="2"></div>
      <div class="onb-dot" data-step="3"></div>
    </div>
    <span class="onb-progress-text">Step <span id="current-step">1</span> of 3</span>
  </div>

</div>

<style>
/* ================================================================
   ONBOARDING STYLES
================================================================ */

.onboarding-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

/* Step Container */
.onboarding-step {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: var(--space-lg);
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.onboarding-content {
  display: flex;
  flex-direction: column;
  gap: var(--space-lg);
}

/* Illustration */
.onb-illustration {
  display: flex;
  justify-content: center;
  padding: var(--space-2xl) 0;
}

.onb-icon-large {
  font-size: 80px;
  color: var(--primary);
  opacity: 0.3;
}

/* Typography */
.onb-title {
  font-size: var(--font-xl);
  font-weight: 700;
  color: var(--text-primary);
  text-align: center;
  margin: 0;
}

.onb-description {
  font-size: var(--font-md);
  color: var(--text-secondary);
  text-align: center;
  margin: 0;
  line-height: 1.6;
}

/* Controls */
.onb-controls {
  display: flex;
  flex-direction: column;
  gap: var(--space-lg);
}

.onb-control-group {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.onb-label {
  font-size: var(--font-sm);
  font-weight: 600;
  color: var(--text-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.onb-helper {
  font-size: var(--font-xs);
  color: var(--text-muted);
  display: block;
}

/* Input Fields */
.onb-input,
.onb-select {
  width: 100%;
  padding: var(--space-md);
  border: 1px solid var(--divider);
  border-radius: var(--radius-md);
  font-size: var(--font-md);
  color: var(--text-primary);
  background: var(--bg);
  font-family: inherit;
  transition: all var(--transition-normal);
}

.onb-input:focus,
.onb-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(46, 126, 157, 0.1);
}

.onb-input::placeholder {
  color: var(--text-muted);
}

/* Location Input with Button */
.onb-location-input {
  display: flex;
  gap: var(--space-xs);
}

.onb-location-input .onb-input {
  flex: 1;
}

.onb-btn-icon {
  width: 48px;
  height: 48px;
  padding: 0;
  border: 1px solid var(--divider);
  background: var(--surface);
  border-radius: var(--radius-md);
  color: var(--primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all var(--transition-normal);
}

.onb-btn-icon:active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* Radio Group */
.onb-radio-group {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.onb-radio {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  padding: var(--space-md);
  border: 1px solid var(--divider);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-normal);
}

.onb-radio:hover {
  background: var(--surface-soft);
}

.onb-radio input[type="radio"] {
  cursor: pointer;
  width: 20px;
  height: 20px;
}

.onb-radio span {
  color: var(--text-primary);
  font-weight: 500;
}

.onb-radio input[type="radio"]:checked ~ span {
  color: var(--primary);
  font-weight: 600;
}

/* Language Grid */
.onb-language-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-md);
}

.onb-language-card {
  position: relative;
  cursor: pointer;
}

.onb-language-card input {
  display: none;
}

.onb-language-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-sm);
  padding: var(--space-lg);
  border: 2px solid var(--divider);
  border-radius: var(--radius-md);
  background: var(--surface);
  transition: all var(--transition-normal);
  text-align: center;
}

.onb-language-card input:checked ~ .onb-language-content {
  border-color: var(--primary);
  background: rgba(46, 126, 157, 0.05);
}

.onb-language-icon {
  font-size: 24px;
  color: var(--primary);
  opacity: 0;
  transition: all var(--transition-normal);
}

.onb-language-card input:checked ~ .onb-language-content .onb-language-icon {
  opacity: 1;
}

.onb-language-name {
  font-size: var(--font-md);
  font-weight: 600;
  color: var(--text-primary);
}

.onb-language-code {
  font-size: var(--font-xs);
  color: var(--text-muted);
}

/* Slider */
.onb-slider-container {
  display: flex;
  flex-direction: column;
  gap: var(--space-md);
}

.onb-slider-labels {
  display: flex;
  justify-content: space-between;
  padding: 0 var(--space-sm);
}

.onb-slider {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--progress-track);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}

.onb-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(46, 126, 157, 0.3);
  transition: all var(--transition-normal);
}

.onb-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.onb-slider::-moz-range-thumb {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 8px rgba(46, 126, 157, 0.3);
  transition: all var(--transition-normal);
}

.onb-slider::-moz-range-thumb:hover {
  transform: scale(1.1);
}

.onb-slider-value {
  text-align: center;
  font-size: var(--font-lg);
  font-weight: 600;
  color: var(--primary);
}

.onb-slider-unit {
  margin-left: var(--space-xs);
  font-size: var(--font-sm);
  color: var(--text-muted);
}

/* Info Box */
.onb-info-box {
  display: flex;
  gap: var(--space-md);
  padding: var(--space-md);
  background: rgba(46, 126, 157, 0.05);
  border-left: 4px solid var(--primary);
  border-radius: var(--radius-sm);
}

.onb-info-icon {
  color: var(--primary);
  font-size: 20px;
  flex-shrink: 0;
  padding-top: 2px;
}

.onb-info-text {
  font-size: var(--font-sm);
  color: var(--text-secondary);
  line-height: 1.6;
}

/* Buttons */
.onb-btn-next,
.onb-btn-back {
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--radius-md);
  font-size: var(--font-md);
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all var(--transition-normal);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.onb-btn-next {
  background: var(--primary);
  color: white;
  width: 100%;
}

.onb-btn-next:active {
  background: #2169a6;
  transform: scale(0.98);
}

.onb-btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.onb-btn-finish {
  background: var(--success);
}

.onb-btn-finish:active {
  background: #3a9c5d;
}

.onb-btn-back {
  background: var(--surface);
  color: var(--text-secondary);
  border: 1px solid var(--divider);
  flex: 1;
}

.onb-btn-back:active {
  background: var(--surface-soft);
}

.onb-btn-group {
  display: flex;
  gap: var(--space-md);
}

.onb-btn-group .onb-btn-next {
  flex: 1;
}

/* Progress Indicator */
.onb-progress {
  padding: var(--space-lg) var(--space-md);
  background: var(--surface);
  border-top: 1px solid var(--divider);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-md);
}

.onb-progress-dots {
  display: flex;
  gap: var(--space-sm);
}

.onb-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--divider);
  transition: all var(--transition-normal);
  cursor: pointer;
}

.onb-dot.active {
  background: var(--primary);
  width: 28px;
  border-radius: 5px;
}

.onb-progress-text {
  font-size: var(--font-xs);
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Hidden Input */
.onb-hidden {
  display: none;
}

/* Dark Mode */
:root[data-theme="dark"] .onb-language-card input:checked ~ .onb-language-content {
  background: rgba(78, 182, 204, 0.1);
}

/* NEW DESIGN ELEMENTS */

/* Location Display */
.onb-location-display {
  padding: var(--space-lg);
  background: var(--surface);
  border: 1px solid var(--divider);
  border-radius: var(--radius-lg);
  margin: var(--space-lg) 0;
}

.onb-location-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-md);
}

/* Dropdown Groups */
.onb-dropdown-group {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.onb-dropdown-btn {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: var(--space-md) var(--space-lg);
  border: 2px solid var(--divider);
  background: white;
  border-radius: var(--radius-lg);
  font-size: var(--font-md);
  font-weight: 500;
  color: var(--text-primary);
  cursor: pointer;
  transition: all var(--transition-normal);
}

.onb-dropdown-btn:active {
  border-color: var(--primary);
  background: var(--bg);
}

.onb-dropdown-btn span:first-child {
  font-weight: 500;
  color: var(--text-secondary);
}

/* Language Toggle */
.onb-language-toggle {
  display: flex;
  background: #000;
  border-radius: 50px;
  padding: 4px;
  width: fit-content;
  gap: 0;
}

.onb-toggle-option {
  flex: 1;
  padding: 12px 32px;
  background: #000;
  border: none;
  cursor: pointer;
  border-radius: 50px;
  transition: all var(--transition-normal);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.onb-toggle-radio {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.onb-toggle-label {
  font-size: var(--font-md);
  font-weight: 600;
  color: #fff;
  transition: color var(--transition-normal);
}

.onb-toggle-radio:checked + .onb-toggle-label {
  color: #000;
}

.onb-toggle-option:has(.onb-toggle-radio:checked) {
  background: #fff;
}

.onb-toggle-option:not(:has(.onb-toggle-radio:checked)) {
  background: #000;
}

/* Fancy Slider */
.onb-slider-fancy {
  padding: var(--space-lg) var(--space-md);
}

.onb-slider-track {
  position: relative;
  padding: var(--space-lg) 0;
}

.onb-slider-input {
  width: 100%;
  height: 12px;
  border-radius: 6px;
  background: linear-gradient(to right, #000 0%, #000 50%, #fff 50%, #fff 100%);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}

.onb-slider-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  border: 4px solid #000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.onb-slider-input::-moz-range-thumb {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  border: 4px solid #000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.onb-slider-labels-row {
  display: flex;
  justify-content: space-between;
  margin-top: var(--space-lg);
  padding: 0 var(--space-sm);
  font-weight: 600;
  color: var(--text-primary);
  font-size: var(--font-md);
}

/* Responsive */
@media (max-width: 480px) {
  .onb-language-grid {
    grid-template-columns: 1fr;
  }
  
  .onb-btn-group {
    flex-direction: column;
  }
  
  .onb-btn-group .onb-btn-back {
    flex: none;
  }
  
  .onb-toggle-option {
    padding: 12px 24px;
  }
}
</style>

<script>
/* Onboarding System */

class OnboardingSystem {
  constructor() {
    this.currentStep = 1;
    this.totalSteps = 3;
    this.data = {
      location: '',
      latitude: null,
      longitude: null,
      timezone: '',
      calculationMethod: 'Karachi',
      asrMethod: 'Shafi',
      language: 'en',
      hijriOffset: 0,
      prayerTimes: null
    };
    try {
      this.init();
    } catch (e) {
      console.error('OnboardingSystem init error:', e);
    }
  }

  init() {
    try {
      this.attachEventListeners();
      this.updateProgressIndicator();
      
      // Auto-detect location on init
      this.autoDetectLocation();
      
      // Recreate lucide icons
      if (window.lucide) lucide.createIcons();
    } catch (e) {
      console.error('init error:', e);
    }
  }

  autoDetectLocation() {
    try {
      if (!navigator.geolocation) {
        console.warn('Geolocation not supported');
        this.showSkipLocationOption();
        return;
      }

      // Set a timeout to show skip option after 3 seconds if no response
      const timeoutId = setTimeout(() => {
        this.showSkipLocationOption();
      }, 3000);

      // Auto-trigger location detection without button
      navigator.geolocation.getCurrentPosition(
        (position) => {
          clearTimeout(timeoutId);
          try {
            const { latitude, longitude } = position.coords;
            
            // Store coordinates
            this.data.latitude = latitude;
            this.data.longitude = longitude;
            
            console.log('Auto-detected location:', latitude, longitude);
            
            // Hide skip button since location was detected
            const skipBtn = document.getElementById('skip-location-btn');
            if (skipBtn) skipBtn.style.display = 'none';
            
            // Try to get city name via reverse geocoding
            this.reverseGeocode(latitude, longitude).then(cityName => {
              this.data.location = cityName || `Lat: ${latitude.toFixed(2)}, Lng: ${longitude.toFixed(2)}`;
              
              // Update location display
              const addressEl = document.getElementById('location-display-address');
              if (addressEl) {
                addressEl.textContent = this.data.location;
              }
              
              // Update timezone display
              const timezoneEl = document.getElementById('location-display-timezone');
              if (timezoneEl) {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                timezoneEl.textContent = `Time Zone: ${timezone}`;
              }
              
              // Auto-fetch prayer times for this location
              this.fetchPrayerTimesForLocation(latitude, longitude);
            }).catch(err => {
              console.error('Reverse geocoding error:', err);
              this.data.location = `Lat: ${latitude.toFixed(2)}, Lng: ${longitude.toFixed(2)}`;
              
              // Update location display with coordinates
              const addressEl = document.getElementById('location-display-address');
              if (addressEl) {
                addressEl.textContent = this.data.location;
              }
              
              // Update timezone display
              const timezoneEl = document.getElementById('location-display-timezone');
              if (timezoneEl) {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                timezoneEl.textContent = `Time Zone: ${timezone}`;
              }
              
              this.fetchPrayerTimesForLocation(latitude, longitude);
            });
          } catch (e) {
            console.error('Position handler error:', e);
            this.showSkipLocationOption();
          }
        },
        (error) => {
          clearTimeout(timeoutId);
          console.warn('Auto-detection failed:', error.message);
          // Show skip option when location is denied or fails
          this.showSkipLocationOption();
        },
        { timeout: 3000, enableHighAccuracy: false }
      );
    } catch (e) {
      console.error('autoDetectLocation error:', e);
      this.showSkipLocationOption();
    }
  }

  showSkipLocationOption() {
    try {
      const skipBtn = document.getElementById('skip-location-btn');
      const addressEl = document.getElementById('location-display-address');
      if (skipBtn) {
        skipBtn.style.display = 'block';
        skipBtn.addEventListener('click', () => {
          // User skipped location, proceed with default
          this.data.location = 'Not detected';
          addressEl.textContent = 'Using default settings';
        });
      }
    } catch (e) {
      console.error('showSkipLocationOption error:', e);
    }
  }

  attachEventListeners() {
    try {
      // Step 1 - Next (Continue Button)
      const step1Next = document.getElementById('step-1-next');
      if (step1Next) {
        step1Next._clickHandler = () => {
          console.log('Continue button clicked');
          this.validateStep1();
        };
        step1Next.addEventListener('click', step1Next._clickHandler);
        console.log('Step 1 next button listener attached');
      } else {
        console.warn('Step 1 next button not found');
      }

      // Dropdown buttons for calculation method
      const calcMethodBtn = document.getElementById('calc-method-btn');
      if (calcMethodBtn) {
        calcMethodBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown('calc-method');
        });
      }

      // Dropdown buttons for Asr method
      const asrMethodBtn = document.getElementById('asr-method-btn');
      if (asrMethodBtn) {
        asrMethodBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown('asr-method');
        });
      }

      // Select element change handlers
      const calcSelect = document.getElementById('calculation-method');
      if (calcSelect) {
        calcSelect.addEventListener('change', (e) => {
          this.data.calculationMethod = e.target.value;
          const valueDisplay = document.getElementById('calc-method-value');
          if (valueDisplay) {
            valueDisplay.textContent = this.getCalculationMethodLabel(e.target.value);
          }
          this.closeAllDropdowns();
        });
      }

      const asrSelect = document.getElementById('asr-method');
      if (asrSelect) {
        asrSelect.addEventListener('change', (e) => {
          this.data.asrMethod = e.target.value;
          const valueDisplay = document.getElementById('asr-method-value');
          if (valueDisplay) {
            valueDisplay.textContent = this.getAsrMethodLabel(e.target.value);
          }
          this.closeAllDropdowns();
        });
      }

      // Step 2 - Navigation
      const step2Next = document.getElementById('step-2-next');
      if (step2Next) {
        step2Next.addEventListener('click', () => {
          const langRadio = document.querySelector('input[name="language"]:checked');
          if (langRadio) this.data.language = langRadio.value;
          this.nextStep();
        });
      }

      // Step 3 - Navigation
      const step3Next = document.getElementById('step-3-next');
      if (step3Next) {
        step3Next.addEventListener('click', () => this.completeOnboarding());
      }

      // Hijri offset slider
      const slider = document.getElementById('hijri-offset-slider');
      if (slider) {
        slider.addEventListener('input', (e) => {
          this.data.hijriOffset = parseInt(e.target.value);
        });
      }

      // Progress dots
      document.querySelectorAll('.onb-dot').forEach(dot => {
        dot.addEventListener('click', (e) => {
          try {
            const step = parseInt(e.target.getAttribute('data-step'));
            if (step < this.currentStep) {
              this.goToStep(step);
            }
          } catch (e) {
            console.error('Dot click error:', e);
          }
        });
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        this.closeAllDropdowns();
      });
      
      console.log('All event listeners attached successfully');
    } catch (e) {
      console.error('attachEventListeners error:', e);
    }
  }

  toggleDropdown(type) {
    try {
      const select = document.getElementById(type === 'calc-method' ? 'calculation-method' : 'asr-method');
      if (select) {
        select.click();
      }
    } catch (e) {
      console.error('toggleDropdown error:', e);
    }
  }

  closeAllDropdowns() {
    try {
      const selects = document.querySelectorAll('select[id*="method"]');
      selects.forEach(select => select.style.display = 'none');
    } catch (e) {
      console.error('closeAllDropdowns error:', e);
    }
  }

  getCalculationMethodLabel(value) {
    const labels = {
      'Karachi': 'Karachi',
      'ISNA': 'ISNA',
      'MWL': 'Muslim World League',
      'Dubai': 'Dubai',
      'Egypt': 'Egypt',
      'Jafari': 'Jafari'
    };
    return labels[value] || value;
  }

  getAsrMethodLabel(value) {
    const labels = {
      'Shafi': 'Shafi',
      'Hanafi': 'Hanafi'
    };
    return labels[value] || value;
  }

  validateStep1() {
    try {
      // Location is now optional - user can skip it
      // But we still need to get calculation method
      
      // Get calculation method from select element
      const calcMethodEl = document.getElementById('calculation-method');
      if (calcMethodEl) {
        this.data.calculationMethod = calcMethodEl.value;
      }

      // Get Asr method from select element
      const asrMethodEl = document.getElementById('asr-method');
      if (asrMethodEl) {
        this.data.asrMethod = asrMethodEl.value;
      }

      // If no location was detected, it's okay - use default
      if (!this.data.location) {
        this.data.location = 'Not specified';
      }

      this.nextStep();
    } catch (e) {
      console.error('validateStep1 error:', e);
      alert('Error validating step 1. Please try again.');
    }
  }

  nextStep() {
    try {
      if (this.currentStep < this.totalSteps) {
        this.goToStep(this.currentStep + 1);
      }
    } catch (e) {
      console.error('nextStep error:', e);
    }
  }

  previousStep() {
    try {
      if (this.currentStep > 1) {
        this.goToStep(this.currentStep - 1);
      }
    } catch (e) {
      console.error('previousStep error:', e);
    }
  }

  goToStep(step) {
    try {
      // Hide current step
      const currentStepEl = document.getElementById(`step-${this.currentStep}`);
      if (currentStepEl) {
        currentStepEl.style.display = 'none';
      }

      // Show new step
      const newStepEl = document.getElementById(`step-${step}`);
      if (newStepEl) {
        newStepEl.style.display = 'flex';
      }

      this.currentStep = step;
      this.updateProgressIndicator();
      
      // Collect data from current step if navigating forward
      if (step === 2) {
        const langRadio = document.querySelector('input[name="language"]:checked');
        if (langRadio) this.data.language = langRadio.value;
      } else if (step === 3) {
        const slider = document.getElementById('hijri-offset-slider');
        if (slider) this.data.hijriOffset = parseInt(slider.value);
      }
    } catch (e) {
      console.error('goToStep error:', e);
    }
  }

  updateProgressIndicator() {
    try {
      const currentStepEl = document.getElementById('current-step');
      if (currentStepEl) {
        currentStepEl.textContent = this.currentStep;
      }
      
      document.querySelectorAll('.onb-dot').forEach((dot, index) => {
        const step = index + 1;
        if (step <= this.currentStep) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    } catch (e) {
      console.error('updateProgressIndicator error:', e);
    }
  }

  detectLocation() {
    try {
      const btn = document.getElementById('location-detect-btn');
      if (!btn) return;
      
      btn.disabled = true;
      btn.textContent = 'Detecting...';

      if (!navigator.geolocation) {
        alert('Geolocation is not supported on your device');
        btn.disabled = false;
        btn.textContent = 'Detect Location';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          try {
            const { latitude, longitude } = position.coords;
            
            // Store coordinates
            this.data.latitude = latitude;
            this.data.longitude = longitude;
            
            // Try to get city name via reverse geocoding (free API)
            this.reverseGeocode(latitude, longitude).then(cityName => {
              const input = document.getElementById('location-input');
              if (input) {
                input.value = cityName || `Lat: ${latitude.toFixed(2)}, Lng: ${longitude.toFixed(2)}`;
              }
              btn.disabled = false;
              btn.textContent = 'Detect Location';
              
              // Auto-fetch prayer times for this location
              this.fetchPrayerTimesForLocation(latitude, longitude);
            }).catch(err => {
              console.error('Reverse geocoding error:', err);
              const input = document.getElementById('location-input');
              if (input) {
                input.value = `Lat: ${latitude.toFixed(2)}, Lng: ${longitude.toFixed(2)}`;
              }
              btn.disabled = false;
              btn.textContent = 'Detect Location';
              this.fetchPrayerTimesForLocation(latitude, longitude);
            });
          } catch (e) {
            console.error('Position handler error:', e);
            btn.disabled = false;
            btn.textContent = 'Detect Location';
          }
        },
        (error) => {
          console.error('Geolocation error:', error);
          alert('Unable to detect location. Please enter location or use manual method.');
          btn.disabled = false;
          btn.textContent = 'Detect Location';
        },
        { timeout: 10000, enableHighAccuracy: false }
      );
    } catch (e) {
      console.error('detectLocation error:', e);
    }
  }

  async reverseGeocode(lat, lng) {
    try {
      // Using Open Street Map Nominatim API (free, no key required)
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
        { headers: { 'Accept': 'application/json' } }
      );
      
      if (!response.ok) throw new Error('Reverse geocoding failed');
      
      const data = await response.json();
      
      // Try to get city name
      const city = data.address?.city || 
                   data.address?.town || 
                   data.address?.village ||
                   data.name ||
                   null;
      
      return city;
    } catch (e) {
      console.error('Reverse geocode error:', e);
      return null;
    }
  }

  async fetchPrayerTimesForLocation(lat, lng) {
    try {
      const method = document.getElementById('calculation-method')?.value || 'Karachi';
      
      const response = await fetch(
        `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=${this.getMethodCode(method)}`
      );
      
      if (!response.ok) throw new Error('Failed to fetch prayer times');
      
      const data = await response.json();
      if (data.code === 200) {
        // Store prayer times
        this.data.prayerTimes = data.data.timings;
        this.data.latitude = lat;
        this.data.longitude = lng;
        
        console.log('Prayer times fetched successfully:', data.data.timings);
      }
    } catch (e) {
      console.error('Fetch prayer times error:', e);
    }
  }

  getMethodCode(method) {
    const methods = {
      'Karachi': '5',
      'ISNA': '7',
      'MWL': '3',
      'Makkah': '4',
      'Egypt': '2',
      'Dubai': '8'
    };
    return methods[method] || '5';
  }

  completeOnboarding() {
    try {
      // Collect final data
      const slider = document.getElementById('hijri-offset-slider');
      if (slider) {
        this.data.hijriOffset = parseInt(slider.value);
      }

      const langRadio = document.querySelector('input[name="language"]:checked');
      if (langRadio) {
        this.data.language = langRadio.value;
      }

      // Validate that we have a location
      const locationInput = document.getElementById('location-input');
      const location = locationInput?.value.trim();
      if (!location) {
        alert('Please enter or detect your location');
        return;
      }
      this.data.location = location;

      // Get calculation method
      const calcMethodEl = document.getElementById('calculation-method');
      if (calcMethodEl) {
        this.data.calculationMethod = calcMethodEl.value;
      }

      // Save to localStorage
      localStorage.setItem('onboardingCompleted', 'true');
      localStorage.setItem('userPreferences', JSON.stringify(this.data));
      localStorage.setItem('userLocation', this.data.location);
      localStorage.setItem('userLatitude', this.data.latitude ? this.data.latitude.toString() : '');
      localStorage.setItem('userLongitude', this.data.longitude ? this.data.longitude.toString() : '');
      localStorage.setItem('calculationMethod', this.data.calculationMethod);
      
      if (this.data.prayerTimes) {
        localStorage.setItem('prayerTimes', JSON.stringify(this.data.prayerTimes));
      }

      // Apply settings
      this.applySettings();

      // Redirect to home
      this.redirectToHome();
    } catch (e) {
      console.error('completeOnboarding error:', e);
      alert('Error completing onboarding. Please try again.');
    }
  }

  applySettings() {
    try {
      // Apply language
      localStorage.setItem('language', this.data.language);
      
      // Apply hijri offset
      localStorage.setItem('hijriOffset', this.data.hijriOffset.toString());
      
      // Apply calculation method
      localStorage.setItem('calculationMethod', this.data.calculationMethod);
      
      // Apply location if provided
      if (this.data.location) {
        localStorage.setItem('userLocation', this.data.location);
      }
    } catch (e) {
      console.error('applySettings error:', e);
    }
  }

  redirectToHome() {
    try {
      // Hide onboarding
      const container = document.getElementById('onboarding-shell');
      if (container) {
        container.style.display = 'none';
      }

      // Show main app
      const appShell = document.getElementById('app-shell');
      if (appShell) {
        appShell.style.display = 'flex';
      }

      // Load home page
      if (window.loadPage) {
        window.loadPage('home');
      }
    } catch (e) {
      console.error('redirectToHome error:', e);
      // Fallback to hard reload
      setTimeout(() => location.reload(), 500);
    }
  }
}

// Initialize onboarding when page loads
let onboardingInstance = null;
function initOnboarding() {
  onboardingInstance = new OnboardingSystem();
}

// Export for use in app.js
window.initOnboarding = initOnboarding;
</script>
