<div id="onboarding-shell" class="onboarding-container">

  <!-- Step 1: Location & Prayer Calculation -->
  <div class="onboarding-step" id="step-1" data-step="1">
    <div class="onboarding-content">
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="120" height="120" style="margin: 0 auto;">
          <circle cx="100" cy="100" r="80" fill="#4a9d6f" opacity="0.8"/>
          <path d="M 100 20 Q 150 60 150 100 Q 150 140 100 160 Q 50 140 50 100 Q 50 60 100 20" fill="#f4d856"/>
          <circle cx="75" cy="85" r="12" fill="#4a9d6f"/>
          <g transform="translate(130, 50)">
            <circle cx="0" cy="0" r="16" fill="#000" opacity="0.8"/>
            <circle cx="0" cy="0" r="14" fill="#fff"/>
            <circle cx="0" cy="0" r="6" fill="#000"/>
          </g>
        </svg>
      </div>

      <h1 class="onb-title">Prayer Time Setup</h1>

      <div class="onb-form-group">
        <label class="onb-label">Location</label>
        <p class="onb-helper">Enter your city for accurate prayer times</p>
        <div class="onb-input-group">
          <input 
            type="text" 
            id="location-input" 
            class="onb-input" 
            placeholder="e.g., Dhaka, New York, London"
            autocomplete="off"
          />
          <button id="detect-location-btn" class="onb-btn-icon" title="Auto-detect location">
            üìç
          </button>
        </div>
        <p id="location-status" class="onb-helper" style="font-size: 12px; margin-top: 4px; min-height: 16px;"></p>
      </div>

      <div class="onb-form-group">
        <label class="onb-label">Calculation Method</label>
        <select id="calculation-method" class="onb-select">
          <option value="Karachi">Karachi (Shafi)</option>
          <option value="ISNA">ISNA (North America)</option>
          <option value="MWL">Muslim World League</option>
          <option value="Makkah">Umm Al-Qura (Makkah)</option>
          <option value="Egypt">Egyptian General Authority</option>
          <option value="Dubai">Dubai (Gulf)</option>
        </select>
      </div>

      <div class="onb-form-group">
        <label class="onb-label">Asr Calculation</label>
        <select id="asr-method" class="onb-select">
          <option value="Shafi">Shafi</option>
          <option value="Hanafi" selected>Hanafi</option>
        </select>
      </div>

      <button class="onb-btn-next" id="step-1-next">Continue</button>
    </div>
  </div>

  <!-- Step 2: Language Selection -->
  <div class="onboarding-step" id="step-2" data-step="2" style="display:none;">
    <div class="onboarding-content">
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="100" height="100" style="margin: 0 auto;">
          <rect x="70" y="80" width="8" height="80" fill="#333"/>
          <path d="M 78 90 Q 140 85 140 120 Q 140 155 78 150 Z" fill="#1aa260"/>
          <circle cx="105" cy="120" r="20" fill="#e21e1e"/>
        </svg>
      </div>

      <h1 class="onb-title">Choose Language</h1>
      <p class="onb-description">Select your preferred language</p>

      <div style="display: flex; justify-content: center; margin: 32px 0;">
        <div class="onb-language-toggle">
          <label class="onb-toggle-option">
            <input type="radio" name="language" value="en" checked>
            <span class="onb-toggle-label">English</span>
          </label>
          <label class="onb-toggle-option">
            <input type="radio" name="language" value="bn">
            <span class="onb-toggle-label">Bangla</span>
          </label>
        </div>
      </div>

      <button class="onb-btn-next" id="step-2-next">Continue</button>
    </div>
  </div>

  <!-- Step 3: Hijri Date Adjustment -->
  <div class="onboarding-step" id="step-3" data-step="3" style="display:none;">
    <div class="onboarding-content">
      <div class="onb-illustration">
        <svg viewBox="0 0 200 200" width="120" height="120" style="margin: 0 auto;">
          <circle cx="100" cy="100" r="90" fill="#3d5a80" opacity="0.7"/>
          <circle cx="60" cy="40" r="2" fill="#fff" opacity="0.6"/>
          <circle cx="140" cy="50" r="1.5" fill="#fff" opacity="0.5"/>
          <circle cx="160" cy="140" r="1" fill="#fff" opacity="0.4"/>
          <circle cx="100" cy="100" r="32" fill="#ffc107"/>
          <circle cx="50" cy="60" r="16" fill="#4caf50"/>
          <circle cx="55" cy="55" r="4" fill="#ffeb3b"/>
          <circle cx="140" cy="120" r="18" fill="#cd853f"/>
          <ellipse cx="140" cy="120" rx="28" ry="8" fill="none" stroke="#a67035" stroke-width="2"/>
          <g transform="translate(75, 45)">
            <polygon points="0,-15 -8,5 -3,5 3,5 8,5" fill="#ff5722"/>
            <rect x="-5" y="5" width="10" height="12" fill="#e0e0e0"/>
          </g>
        </svg>
      </div>

      <h1 class="onb-title">Hijri Date</h1>
      <p class="onb-description">Adjust if your country follows a different lunar calendar</p>

      <div style="margin: 32px 0;">
        <div class="onb-slider-fancy">
          <div class="onb-slider-track">
            <input type="range" id="hijri-offset-slider" min="-2" max="2" value="0" step="1" class="onb-slider-input">
          </div>
          <div class="onb-slider-labels-row">
            <span>-2</span>
            <span>-1</span>
            <span style="font-weight: 600; color: var(--primary);">0</span>
            <span>+1</span>
            <span>+2</span>
          </div>
        </div>
      </div>

      <p style="text-align: center; font-size: 14px; color: var(--text-secondary); margin-top: 24px;">Same day as Saudi Arabia</p>

      <button class="onb-btn-next" id="step-3-next">Complete Setup</button>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="onb-progress">
    <div class="onb-progress-dots">
      <div class="onb-dot active" data-step="1"></div>
      <div class="onb-dot" data-step="2"></div>
      <div class="onb-dot" data-step="3"></div>
    </div>
    <span class="onb-progress-text">Step <span id="current-step">1</span> of 3</span>
  </div>

</div>

<style>
/* ================================================================
   ONBOARDING STYLES
================================================================ */

.onboarding-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.onboarding-step {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: var(--space-lg, 24px);
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.onboarding-content {
  display: flex;
  flex-direction: column;
  gap: var(--space-lg, 24px);
}

.onb-illustration {
  display: flex;
  justify-content: center;
  padding: var(--space-2xl, 32px) 0;
}

.onb-title {
  font-size: var(--font-xl, 24px);
  font-weight: 700;
  color: var(--text-primary);
  text-align: center;
  margin: 0;
}

.onb-description {
  font-size: var(--font-md, 16px);
  color: var(--text-secondary);
  text-align: center;
  margin: 0;
  line-height: 1.6;
}

.onb-form-group {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm, 8px);
}

.onb-label {
  font-size: var(--font-sm, 14px);
  font-weight: 600;
  color: var(--text-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.onb-helper {
  font-size: var(--font-xs, 12px);
  color: var(--text-secondary);
  margin: 0;
}

.onb-input-group {
  display: flex;
  gap: var(--space-xs, 8px);
}

.onb-input,
.onb-select {
  width: 100%;
  padding: var(--space-md, 16px);
  border: 1px solid var(--divider);
  border-radius: var(--radius-md, 8px);
  font-size: var(--font-md, 16px);
  color: var(--text-primary);
  background: var(--bg);
  font-family: inherit;
  transition: all 0.2s;
}

.onb-input-group .onb-input {
  flex: 1;
}

.onb-input:focus,
.onb-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(46, 126, 157, 0.1);
}

.onb-input::placeholder {
  color: var(--text-secondary);
}

.onb-btn-icon {
  width: 48px;
  height: 48px;
  padding: 0;
  border: 1px solid var(--divider);
  background: var(--bg);
  border-radius: var(--radius-md, 8px);
  color: var(--primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.onb-btn-icon:active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.onb-btn-next {
  width: 100%;
  padding: var(--space-md, 16px);
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius-md, 8px);
  font-size: var(--font-md, 16px);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: var(--space-lg, 24px);
}

.onb-btn-next:active {
  opacity: 0.9;
  transform: scale(0.98);
}

/* Language Toggle */
.onb-language-toggle {
  display: flex;
  background: #000;
  padding: 4px;
  border-radius: var(--radius-md, 8px);
  gap: 0;
}

.onb-toggle-option {
  flex: 1;
  position: relative;
}

.onb-toggle-option input[type="radio"] {
  opacity: 0;
  position: absolute;
}

.onb-toggle-label {
  display: block;
  padding: var(--space-md, 16px) var(--space-lg, 24px);
  text-align: center;
  color: var(--text-muted, #999);
  font-weight: 500;
  cursor: pointer;
  border-radius: calc(var(--radius-md, 8px) - 2px);
  transition: all 0.2s;
}

.onb-toggle-option input[type="radio"]:checked ~ .onb-toggle-label {
  background: #fff;
  color: #000;
  font-weight: 600;
}

/* Slider */
.onb-slider-fancy {
  background: var(--surface);
  padding: var(--space-lg, 24px);
  border-radius: var(--radius-md, 8px);
}

.onb-slider-track {
  position: relative;
  padding: var(--space-lg, 24px) 0;
}

.onb-slider-input {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  background: linear-gradient(to right, #000 0%, #fff 100%);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}

.onb-slider-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #000;
  cursor: pointer;
}

.onb-slider-input::-moz-range-thumb {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #000;
  cursor: pointer;
}

.onb-slider-labels-row {
  display: flex;
  justify-content: space-between;
  padding: var(--space-md, 16px) 0 0 0;
  font-size: var(--font-sm, 14px);
  color: var(--text-secondary);
}

/* Progress */
.onb-progress {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-md, 16px);
  padding: var(--space-md, 16px);
  background: var(--surface);
  border-top: 1px solid var(--divider);
}

.onb-progress-dots {
  display: flex;
  gap: var(--space-sm, 8px);
}

.onb-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--divider);
  cursor: pointer;
  transition: all 0.2s;
}

.onb-dot.active {
  background: var(--primary);
  width: 24px;
  border-radius: 5px;
}

.onb-progress-text {
  font-size: var(--font-xs, 12px);
  color: var(--text-secondary);
}

/* Mobile */
@media (max-width: 480px) {
  .onboarding-step {
    padding: var(--space-md, 16px);
  }

  .onb-label {
    font-size: 12px;
  }

  .onb-input,
  .onb-select {
    font-size: 16px;
    padding: var(--space-md, 16px);
  }

  .onb-toggle-label {
    padding: var(--space-sm, 8px) var(--space-md, 16px);
    font-size: 14px;
  }
}
</style>

<script>
class OnboardingSystem {
  constructor() {
    this.currentStep = 1;
    this.totalSteps = 3;
    this.data = {
      location: '',
      calculationMethod: 'Karachi',
      asrMethod: 'Hanafi',
      language: 'en',
      hijriOffset: 0
    };
    this.init();
  }

  init() {
    try {
      this.attachEventListeners();
      this.updateProgressIndicator();
      if (window.lucide) lucide.createIcons();
      // Auto-request location on first visit
      this.autoRequestLocation();
    } catch (e) {
      console.error('Onboarding init error:', e);
    }
  }

  autoRequestLocation() {
    const status = document.getElementById('location-status');
    if (!status) return;

    if (!navigator.geolocation) {
      status.textContent = 'Geolocation not supported';
      return;
    }

    status.textContent = 'Requesting location access...';

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        this.handleLocationSuccess(latitude, longitude);
      },
      (error) => {
        console.warn('Location request denied:', error.message);
        status.textContent = 'Please enter your location manually';
      },
      { timeout: 10000, enableHighAccuracy: false }
    );
  }

  handleLocationSuccess(latitude, longitude) {
    const status = document.getElementById('location-status');
    const input = document.getElementById('location-input');
    
    if (!input || !status) return;

    this.reverseGeocode(latitude, longitude)
      .then(city => {
        const location = city || `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
        input.value = location;
        this.data.location = location;
        status.textContent = 'Location detected ‚úì';

        // Auto-set calculation method based on location
        this.setCalculationMethodByLocation(latitude, longitude);
      })
      .catch(() => {
        const location = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
        input.value = location;
        this.data.location = location;
        status.textContent = 'Location detected ‚úì';
        this.setCalculationMethodByLocation(latitude, longitude);
      });
  }

  setCalculationMethodByLocation(latitude, longitude) {
    // Map regions to calculation methods
    const regions = [
      { name: 'South Asia', method: 'Karachi', latMin: 8, latMax: 35, lngMin: 61, lngMax: 97 },
      { name: 'North America', method: 'ISNA', latMin: 15, latMax: 72, lngMin: -170, lngMax: -52 },
      { name: 'Europe', method: 'MWL', latMin: 35, latMax: 72, lngMin: -10, lngMax: 45 },
      { name: 'Middle East', method: 'Makkah', latMin: 12, latMax: 37, lngMin: 25, lngMax: 65 },
      { name: 'Egypt', method: 'Egypt', latMin: 21, latMax: 32, lngMin: 24, lngMax: 36 },
      { name: 'UAE', method: 'Dubai', latMin: 22.5, latMax: 26.5, lngMin: 51, lngMax: 56 }
    ];

    let method = 'Karachi'; // Default

    for (let region of regions) {
      if (latitude >= region.latMin && latitude <= region.latMax &&
          longitude >= region.lngMin && longitude <= region.lngMax) {
        method = region.method;
        break;
      }
    }

    this.data.calculationMethod = method;
    const select = document.getElementById('calculation-method');
    if (select) {
      select.value = method;
      const status = document.getElementById('location-status');
      if (status) {
        status.textContent = `Location detected ‚úì - Calculation set to ${method}`;
      }
    }
  }

  attachEventListeners() {
    try {
      // Step 1
      document.getElementById('step-1-next')?.addEventListener('click', () => this.validateStep1());
      document.getElementById('detect-location-btn')?.addEventListener('click', () => this.detectLocation());
      document.getElementById('location-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') this.validateStep1();
      });

      // Step 2
      document.getElementById('step-2-next')?.addEventListener('click', () => {
        const lang = document.querySelector('input[name="language"]:checked');
        if (lang) this.data.language = lang.value;
        this.nextStep();
      });

      // Step 3
      document.getElementById('step-3-next')?.addEventListener('click', () => this.completeOnboarding());
      document.getElementById('hijri-offset-slider')?.addEventListener('change', (e) => {
        this.data.hijriOffset = parseInt(e.target.value);
      });

      // Progress dots
      document.querySelectorAll('.onb-dot').forEach(dot => {
        dot.addEventListener('click', (e) => {
          const step = parseInt(e.target.getAttribute('data-step'));
          if (step < this.currentStep) this.goToStep(step);
        });
      });
    } catch (e) {
      console.error('Event listener error:', e);
    }
  }

  validateStep1() {
    const location = document.getElementById('location-input')?.value.trim();
    if (!location) {
      document.getElementById('location-status').textContent = 'Please enter a location';
      return;
    }

    this.data.location = location;
    this.data.calculationMethod = document.getElementById('calculation-method')?.value || 'Karachi';
    this.data.asrMethod = document.getElementById('asr-method')?.value || 'Hanafi';
    this.nextStep();
  }

  detectLocation() {
    const btn = document.getElementById('detect-location-btn');
    const status = document.getElementById('location-status');
    if (!btn || !status) return;

    btn.disabled = true;
    btn.textContent = '‚è≥';
    status.textContent = 'Detecting...';

    if (!navigator.geolocation) {
      status.textContent = 'Geolocation not supported';
      btn.disabled = false;
      btn.textContent = 'üìç';
      return;
    }

    const timeout = setTimeout(() => {
      status.textContent = 'Detection timed out';
      btn.disabled = false;
      btn.textContent = 'üìç';
    }, 5000);

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        clearTimeout(timeout);
        const { latitude, longitude } = pos.coords;
        this.handleLocationSuccess(latitude, longitude);
        btn.disabled = false;
        btn.textContent = 'üìç';
      },
      (error) => {
        clearTimeout(timeout);
        console.warn('Geolocation error:', error.message);
        status.textContent = 'Permission denied - enter location manually';
        btn.disabled = false;
        btn.textContent = 'üìç';
      },
      { timeout: 5000, enableHighAccuracy: false }
    );
  }

  reverseGeocode(lat, lng) {
    return fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
      .then(r => r.json())
      .then(data => data.address?.city || data.address?.town || data.address?.county || '')
      .catch(() => '');
  }

  nextStep() {
    if (this.currentStep < this.totalSteps) {
      this.goToStep(this.currentStep + 1);
    }
  }

  goToStep(step) {
    document.getElementById(`step-${this.currentStep}`)?.style.setProperty('display', 'none');
    document.getElementById(`step-${step}`)?.style.setProperty('display', 'flex');
    this.currentStep = step;
    this.updateProgressIndicator();
  }

  updateProgressIndicator() {
    document.getElementById('current-step').textContent = this.currentStep;
    document.querySelectorAll('.onb-dot').forEach((dot, i) => {
      if (i + 1 <= this.currentStep) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }

  completeOnboarding() {
    this.data.language = document.querySelector('input[name="language"]:checked')?.value || 'en';
    this.data.hijriOffset = parseInt(document.getElementById('hijri-offset-slider')?.value || 0);

    localStorage.setItem('onboardingCompleted', 'true');
    localStorage.setItem('userSettings', JSON.stringify(this.data));

    if (window.skipOnboarding) {
      window.skipOnboarding();
    } else {
      window.location.reload();
    }
  }
}

// Initialize
let onboardingInstance = null;
function initOnboarding() {
  onboardingInstance = new OnboardingSystem();
}

window.initOnboarding = initOnboarding;
</script>
